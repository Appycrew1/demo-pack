import * as cheerio from "cheerio";import normalizeUrl from "normalize-url";function absolutize(base:URL,maybe?:string|null):string|null{if(!maybe)return null;try{return new URL(maybe,base).toString();}catch{return null;}}export async function fetchBrandFromUrl(inputUrl:string){const site=new URL(normalizeUrl(inputUrl,{stripWWW:false,forceHttps:true}));const res=await fetch(site.toString(),{redirect:"follow"});if(!res.ok)throw new Error(`Fetch failed: ${res.status}`);const html=await res.text();const $=cheerio.load(html);const candidates=new Set<string>();const push=(v:string|null)=>{if(v)candidates.add(v);};$('link[rel="icon"], link[rel="shortcut icon"], link[rel="apple-touch-icon"], link[rel="mask-icon"]').each((_,el)=>{push(absolutize(site,$(el).attr("href")));});push(absolutize(site,$('meta[property="og:logo"]').attr("content")||null));push(absolutize(site,$('meta[property="og:image"]').attr("content")||null));push(absolutize(site,$('meta[name="twitter:image"]').attr("content")||null));["/favicon.ico","/favicon.png","/logo.png","/static/logo.png","/images/logo.png","/assets/logo.svg"].forEach(p=>push(new URL(p,site).toString()));const ordered=Array.from(candidates).sort((a,b)=>{const ext=(u:string)=>u.split("?")[0].split(".").pop()?.toLowerCase()||"";const score=(u:string)=>{let s=0;const e=ext(u);if(e==="svg")s+=5;if(e==="png")s+=4;if(e==="ico")s+=3;if(u.includes("apple-touch-icon"))s+=2;if(u.includes("192x192")||u.includes("512"))s+=1;if(u.includes("sprite"))s-=5;if(u.includes("social"))s-=3;if(u.length>40)s+=1;return s;};return score(b)-score(a);});return {orderedIconUrls:ordered,canonicalUrl:site.toString()};}
